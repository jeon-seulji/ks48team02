<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout/default}">

<head>
    <!--  사용자별 css file 추가 부분 -->
    <title th:text="${title}"></title>
</head>


<!-- 사용자 페이지별 javascript file -->
<th:block layout:fragment="customJsFile">
    <script th:src="@{/admin/js/settlement/settlementJs.js}"></script>
</th:block>

<!-- 사용자별 스크립트 작성 -->
<th:block layout:fragment="customJsCode">
    <script type="text/javascript">
        // 기간 선택 min value setting
        $('input[name="amDateSettStartDate"]').on('change', function(){
            let startDate = $(this).val();
            $('input[name="amDateSettEndDate"]').prop('min',startDate);
        });




        let startDateValue = startDate(nowDateSet);
        let endDateValue = `${nowDateSet.getFullYear()}-${String(nowDateSet.getMonth() + 1).padStart(2, '0')}-${String(nowDateSet.getDate()).padStart(2, '0')}`;

        console.log(startDateValue, '<-- start value');
        console.log(endDateValue, '<-- end value');

        $('input[name="amDateSettStartDate"]').val(startDateValue);
        $('input[name="amDateSettEndDate"]').val(endDateValue);





        // loaded category checkbox all checked
        const $categoryEls = $('.order-category-select input');
        $($categoryEls).prop('checked', true);

        // price form
        const priceEls = $('input[name="orderPrice"]');
        payFormat(priceEls);


        /* ajax */

        // admin orderList ajax
        function adminOrderListAjax(orderby, currentPage, rowPerPage, callback){
            const request = $.ajax({
                url: '/admin/order/ajax/list',
                method : 'POST',
                data : {"orderby" : orderby, "currentPage" : currentPage, "rowPerPage" : rowPerPage},
                dataType: 'json'
            })
            request.done(function(list){
                // console.log(list, '<--');
                callback(list);
            });
            request.fail(function(err){
                console.log(err);
            });
        }
        // order data setting
        function setOrderData(list){
            // add ajax contents
            $('#orderListForm tbody').remove();
            $('#orderListForm table').append('<tbody></tbody>');
            if (list.length == 0) {
                $('#orderListForm tbody').append(`<tr>
                                             <td colspan="10" style="text-align: center; padding: 30px 0;">검색 결과가 없습니다.</td>
                                          </tr>`);
            }
            $(list).each((idx, l) => {
                $('#orderListForm tbody').append(`<tr></tr>`)
                    .append(
                        `<td class="table-data-center">
                    <input type="checkbox" name="selectList">
                 </td>`
                    )
                    .append(
                        `<td class="table-data-center">
                    <a title="${l.orderCode}" class="detail-link" href="/admin/order/detail?orderCode=${l.orderCode}&goodsPartition=${l.goodsPartition}">${l.orderCode}</a>
                 </td>`
                    )
                    .append(
                        `<td title="${l.orderApplicationDate}" class="table-data-center">
                    ${l.orderApplicationDate}
                 </td>`
                    )
                    .append(
                        `<td class="table-data-center">
                    <span>${l.goodsPartition === 'rwd' ? '리워드' : (l.goodsPartition === 'don' ? '기부' : '투자')}</span>
                </td>`
                    )
                    .append(
                        `<td title="${l.orderFundingName}" class="table-data-center">
                    ${l.orderFundingName}
                </td>`
                    )
                    .append(
                        `<td title="${l.orderCategoryDetail}">
                    ${l.orderCategoryDetail}
                </td>`
                    )
                    .append(
                        `<td class="table-data-center">
                    ${l.orderName}
                </td>`
                    )
                    .append(
                        `<td  class="table-data-center">
                    <input type="hidden" name="orderPrice" value="${l.orderTotalPrice}">
                    <span class="order-pay">0</span> 원
                </td>`
                    )
                    .append(
                        `<td class="table-data-center">
                    ${l.orderConfirmDate == null? '-':l.orderConfirmDate}
                </td>`
                    )
                    .append(
                        `<td class="table-data-center">
                    ${l.orderCancellDate == null? '-':l.orderCancellDate}
                </td>`
                    )

            });


            let priceEls = $('input[name="orderPrice"]');
            payFormat(priceEls);
        }

        // pager setting
        function setPagerData(arr, currentPage, list){
            console.log(list, '<--list');
            let lastPage = list.lastPage;
            let startPageNum = list.startPageNum;
            $('.list-btn-area button').removeClass('no-action');

            if(currentPage == startPageNum) {
                $('.prev-transfer').addClass('no-action');
            }
            if(currentPage == lastPage){
                $('.next-transfer').addClass('no-action');
            }

            $('.order-list-pager li').remove();
            $(arr).each((idx, item) => {
                let classArr = [];
                if(item == currentPage) {
                    classArr.push('link-active');
                    classArr.push('currentPage');
                }
                if(item == startPageNum) classArr.push('startPageNum');
                if(item == lastPage) classArr.push('lastPage');

                // console.log(classArr, '<-- classArr');
                $('.order-list-pager').append(`<li class="${classArr.join(' ')}"><a data-value="${item}">${item}</a></li>`);
            });
        }

        // select 옵션 선택 ajax
        $('select[name="orderby"], select[name="count-select"]').on('change',function(){
            $('#allSelectBtn').prop('checked', false);
            let orderbyValue = $('select[name="orderby"]').val();

            $('.select-list-count').text('0');

            // page value
            let currentPage = 1;
            let rowPerPage = $('select[name="count-select"]').val();


            // ajax 호출
            adminOrderListAjax(orderbyValue, currentPage, rowPerPage, function(list) {
                // list count
                $('.total-list').text(list.orderList.length);
                setOrderData(list.orderList);

                // pager setting
                const pageNumArr = Array((list.endPageNum - list.startPageNum) + 1).fill().map((item, idx) => list.startPageNum + idx);
                setPagerData(pageNumArr, list.currentPage, list);

            });
        });

        // 페이징 ajax
        $(document).on('click', '.order-list-pager a',function(e){
            let pageNumber = $(e.target).attr('data-value');
            let orderbyValue = $('select[name="orderby"]').val();
            let rowPerPage = $('select[name="count-select"]').val();
            // ajax 호출
            adminOrderListAjax(orderbyValue, pageNumber, rowPerPage, function(list){
                // list count
                $('.total-list').text(list.orderList.length);
                setOrderData(list.orderList);

                // pager setting
                const pageNumArr = Array((list.endPageNum - list.startPageNum) + 1).fill().map((item, idx) => list.startPageNum + idx);
                setPagerData(pageNumArr, list.currentPage, list);
            });
        });

        // prev, next click ajax
        $(document).on('click', '.list-btn-area button', function(e){
            let validation = $(e.target).closest('button').hasClass('no-action');

            if(validation){
                let value = $(e.target).text();
                alert(`${(value.replaceAll(/\s/g, '') == 'prev')? '첫 번째':'마지막' } 페이지 입니다.`);
                return;
            }

            const $orderListLi = $('.order-list-pager li');
            let currentPage;

            // current Page Number Validation
            $($orderListLi).each((idx, element) => {
                let validation = $(element).hasClass('currentPage');
                if(validation) {
                    currentPage = $(element).text();
                    return;
                }
            });

            // ajax 호출
            let orderbyValue = $('select[name="orderby"]').val();
            let rowPerPage = $('select[name="count-select"]').val();

            // page number array
            const numberArr = $.map($orderListLi, function(element, idx){
                return $(element).find('a').text();
            });

            if($(e.target).parent().hasClass('prev-transfer')){
                currentPage--;
            } else if($(e.target).parent().hasClass('next-transfer')){
                currentPage++;
            }

            adminOrderListAjax(orderbyValue, currentPage, rowPerPage, function(list) {
                // list count
                $('.total-list').text(list.orderList.length);
                setOrderData(list.orderList);

                // pager setting
                setPagerData(numberArr, currentPage, list);

            });



        });
        // order search ajax
        function orderSearchAjax(queryString, callback){
            const request = $.ajax({
                url: '/admin/order/ajax/search',
                method : 'POST',
                data : queryString,
                contentType: 'application/json',
                dataType: 'json'
            })
            request.done(function(list){
                // console.log(list, '<--');
                callback(list);
            });
            request.fail(function(err){
                console.log(err);
            });
        }

        $('.orderSearchBtn').on('click', function(){
            console.log('aa');
            const $inputEls = $('.order-category-select input:checked');
            console.log($inputEls);
            const arr = [];
            $($inputEls).each((idx, item) => {
                let checkBoxValue = $(item).attr('name');
                arr.push(checkBoxValue);
            });
            console.log(arr, '<--arr');

            let userSettStartDate = $('input[name="userSettStartDate"]').val();
            let userSettEndDate = $('input[name="userSettEndDate"]').val();
            let userSearchKey = $('select[name="userSearchKey"]').val();
            let userSearchable = $('select[name="userSearchable"]').val();

            $('input[name="amDateSettStartDate"]').val(userSettStartDate);
            $('input[name="amDateSettEndDate"]').val(userSettEndDate);
            $('input[name="orderCategoryCode"]').val(arr);
            $('input[name="searchKey"]').val(userSearchKey);
            $('input[name="searchValue"]').val(userSearchable);

            let queryString = $('#searchForm').serialize();
            console.log(queryString, '<-- queryString');
            orderSearchAjax(queryString, function(list){
                console.log(list, '<--list');
            });
        });
    </script>

</th:block>


<!--/* layout:decorate : 파일에서 사용자 정의로 선언한 조각에 작성한 html 코드 삽입 */-->
<th:block layout:fragment="customContents">
    <div class="admin-content-wrapper form-table">
        <form id="searchForm" name="searchForm">
            <input type="hidden" name="dateSettStartDate">
            <input type="hidden" name="dateSettEndDate">
            <input type="hidden" name="orderCategoryCode">
            <input type="hidden" name="searchKey">
            <input type="hidden" name="searchValue">
        </form>
            <table class="partition-select">
                <tbody>
                    <tr>
                        <td>
                            기간
                        </td>
                        <td>
                            <input type="date" name="amDateSettStartDate">
                            <span> - </span>
                            <input type="date" name="amDateSettEndDate">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            주문 상태
                        </td>
                        <td class="order-category-select" style="height: auto !important;">

                            <ul>
                                <li>
                                    <input id="projecting" type="checkbox" name="projecting">
                                    <label for="projecting">프로젝트 공고중</label>
                                </li>
                                <li>
                                    <input id="projectCompleted" type="checkbox" name="projectCompleted">
                                    <label for="projectCompleted">프로젝트 성공</label>
                                </li>
                                <li>
                                    <input id="projectFail" type="checkbox" name="projectFail">
                                    <label for="projectFail">프로젝트 실패</label>
                                </li>
                                <li>
                                    <input id="refunting" type="checkbox" name="refunting">
                                    <label for="refunting">환불 처리중</label>
                                </li>
                                <li>
                                    <input id="refundCompleted" type="checkbox" name="refundCompleted">
                                    <label for="refundCompleted">환불 완료</label>
                                </li>
                                <li>
                                    <input id="swapping" type="checkbox" name="swapping">
                                    <label for="swapping">교환 처리중</label>
                                </li>
                                <li>
                                    <input id="swappingCompleted" type="checkbox" name="swappingCompleted">
                                    <label for="swappingCompleted">교환 완료</label>
                                </li>
                                <li>
                                    <input id="orderCancle" type="checkbox" name="orderCancle">
                                    <label for="orderCancle">주문 취소</label>
                                </li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            검색 키워드
                        </td>
                        <td class="order-category-select">
                            <select name="userSearchKey">
                                <option value="total">전체</option>
                                <option value="orderCode">주문코드</option>
                                <option value="orderName">주문자명</option>
                                <option value="orderId">주문아이디</option>
                                <option value="projectName">공고명</option>
                                <option value="projectPartition">분류</option>
                            </select>
                            <input type="text" style="padding: 6px 10px; width: 250px;" name="userSearchable">
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="btn-area">
                <button type="button" class="orderSearchBtn submitBtn">검색</button>
            </div>
    </div>
    <div class="title-wrap">
        <h4 class="admin-content-title">주문 목록</h4>
        <div class="btnArea">
            <button type="button" class="printBtn"><span>액셀 다운로드</span></button>
        </div>
    </div>
    <div class="admin-content-wrapper" style="overflow-x: hidden;">
        <div>
            <!-- select are -->
            <div class="data-info">
                <div class="list-count-area">
                    <ul>
                        <li>주문 총 <span class="count-data total-list">0</span>건</li>
                        <li>선택 항목 총 <span class="count-data select-list-count">0</span>건</li>
                    </ul>
                </div>
                <div class="list-count-selector">
                    <select name="orderby">
                        <option value="order_d">주문일 역순</option>
                        <option value="order_a">주문일 순</option>
                        <option>-----------------</option>
                        <option value="order_name_a">주문자 순</option>
                        <option value="order_name_d">주문자 역순</option>
                        <option>-----------------</option>
                        <option value="projecting_o">프로젝트 공고중</option>
                        <option value="projectFail_o">프로젝트 실패</option>
                        <option value="deliveryWait_o">배송대기중</option>
                        <option value="deliveryCompleted_o">배송완료</option>
                        <option value="swapping_o">교환 신청</option>
                        <option value="refunding_o">환불 신청</option>
                        <option value="orderCompleted">주문확정</option>
                    </select>
                    <select name="count-select">
                        <option value="15">15개씩 보기</option>
                        <option value="20">20개씩 보기</option>
                        <option value="30">30개씩 보기</option>
                    </select>
                </div>
            </div>
            <!-- contents area -->
            <form id="orderListForm">
                <table class="settlement-log">
                    <thead>
                        <tr>
                        <th style="width:5%;">
                            <input type="checkbox" name="allSelect" id="allSelectBtn">
                        </th>
                        <th style="width:12%;">주문 관리코드</th>
                        <th style="width:10%;">주문 일시</th>
                        <th style="width:6%;">분류</th>
                        <th style="width:20%;">주문 공고</th>
                        <th style="width:10%;">주문 상태</th>
                        <th style="width:6%;">주문자명</th>
                        <th style="width:10%;">주문 금액</th>
                        <th style="width:10%;">주문 확정 일시</th>
                        <th style="width:10%;">주문 취소 일시</th>
                    </tr>
                    </thead>
                    <tbody>
                        <!-- 조회 결과 없음 -->
                        <tr th:if="${OrderList == null}">
                            <td colspan="10" style="text-align: center; padding: 30px 0;">검색 결과가 없습니다.</td>
                        </tr>
                        <!-- 조회 결과 contents -->
                        <tr th:nuless="${OrderList == null}" th:each="l : ${OrderList}">
                            <td class="table-data-center">
                                <input type="checkbox" name="selectList">
                            </td>
                            <td class="table-data-center">
                                <a th:text="${l.orderCode}" th:title="${l.orderCode}" class="detail-link" th:href="@{/admin/order/detail?(orderCode=${l.orderCode}, goodsPartition=${l.goodsPartition})}">주문 코드</a>
                            </td>
                            <td th:text="${l.orderApplicationDate}" th:title="${l.orderApplicationDate}" class="table-data-center">
                                주문일시
                            </td>
                            <td  class="table-data-center">
                                <span th:if="${l.goodsPartition.equals('rwd')}">리워드</span>
                                <span th:if="${l.goodsPartition.equals('don')}">기부</span>
                                <span th:if="${l.goodsPartition.equals('inv')}">투자</span>
                            </td>
                            <td th:text="${l.orderFundingName}" th:title="${l.orderFundingName}" class="table-data-center">
                                주문공고
                            </td>
                            <td th:text="${l.orderCategoryDetail}" th:title="${l.orderCategoryDetail}">
                                주문 상태
                            </td>
                            <td th:text="${l.orderName}"  class="table-data-center">
                                주문자명
                            </td>
                            <td class="table-data-center">
                                <input type="hidden" name="orderPrice" th:value="${l.orderTotalPrice}">
                                <span class="order-pay">0</span> 원
                            </td>
                            <td th:text="${(l.orderConfirmDate != null)?l.orderConfirmDate:'-'}" class="table-data-center">
                                -
                            </td>
                            <td th:text="${(l.orderCancellDate != null)?l.orderCancellDate:'-'}" class="table-data-center">
                                -
                            </td>
                        </tr>

                    </tbody>
                </table>
            </form>
            <!-- list pager -->
            <div class="board-page-area">
                <div class="list-controller-inner">
                    <ul class="order-list-pager">
                        <th:block th:each="num : ${#numbers.sequence(startPageNum, endPageNum)}">
                            <li th:unless="${num != currentPage}" class="link-active currentPage"><a th:data-value="${num}">[[${num}]]</a></li>
                            <li th:if="${num != currentPage}"><a th:data-value="${num}">[[${num}]]</a></li>
                        </th:block>
                    </ul>
                    <div class="list-btn-area">
                        <th:block th:if="${startPageNum == currentPage}">
                            <button class="prev-transfer no-action">
                                <span>prev</span>
                            </button>
                            <button class="next-transfer">
                                <span>next</span>
                            </button>
                        </th:block>
                        <th:block th:if="${lastPage == currentPage}">
                            <button class="prev-transfer">
                                <span>prev</span>
                            </button>
                            <button class="next-transfer no-action">
                                <span>next</span>
                            </button>
                        </th:block>

                    </div>
                </div>

            </div>
        </div>

    </div>

</th:block>
</html>