<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout/default}">

<head>
    <!--  사용자별 css file 추가 부분 -->
</head>


<!-- 사용자 페이지별 javascript file -->
<th:block layout:fragment="customJsFile">
    <script th:src="@{/common/js/ajaxJs.js}"></script>
    <script th:src="@{/common/js/admin-commonJs.js}"></script>
</th:block>

<!-- 사용자별 컨텐츠 -->
<th:block layout:fragment="customContents">
    <div class="admin-content-wrapper form-table">
        <table class="partition-select">
            <tbody>
            <tr>
                <td>
                    기간
                </td>
                <td>
                    <input type="date" name="amDateSettStartDate" id="start-date">
                    <span> - </span>
                    <input type="date" name="amDateSettEndDate" id="end-date">

                </td>
            </tr>
            <tr>
                <td>
                    회원 ID
                </td>
                <td class="member-category-select">
                    <select name="sellerSearchKey">
                        <option value="total">전체</option>
                        <option value="seller">일반 판매자</option>
                        <option value="representative">대표 판매자</option>
                        <option value="employee">직원 판매자 </option>
                        <option value="orderFundingName">구매자</option>
                    </select>
                    <input type="text" style="padding: 5px; width: 250px;" name="userSearchable" id="search-id">
                </td>
            </tr>
            </tbody>
        </table>
        <div class="btn-area">
            <button type="button" class="orderSearchBtn submitBtn">검색</button>
        </div>
    </div>

    <!-------------------------- 검색 결과 ---------------------------------->
    <div class="title-wrap">
        <h4 class="admin-content-title">회원 로그인 이력</h4>
    </div>
    <div class="admin-content-wrapper" style="overflow-x: hidden;">
        <div>
            <!-- select area -->
            <div class="data-info">
                <div class="list-count-area">
                    <ul>
                        <li>검색 결과 <span class="count-data total-list">0</span>건</li>
                    </ul>
                </div>
                <div class="list-count-selector">
                    <select name="orderby">
                        <option value="order_a">최신 가입일순</option>
                        <option value="orderCompleted">가입일 역순</option>
                    </select>
                    <select name="count-select">
                        <option value="15">15개씩 보기</option>
                        <option value="20">20개씩 보기</option>
                        <option value="30">30개씩 보기</option>
                    </select>
                </div>
            </div>
            <!-- contents area -->
            <table class="login-log">
                <thead>
                <tr>
                    <th style="width:5%;">
                        <input type="checkbox" name="allSelect" id="allSelectBtn">
                    </th>
                    <th style="width:10%;">식별 코드</th>
                    <th style="width:10%;">ID</th>
                    <th style="width:10%;">로그인 일시</th>
                    <th style="width:10%;">로그아웃 일시</th>
                    <th style="width:10%;">접속 IP</th>
                </tr>
                </thead>
                <tbody>
                <!-- 조회 결과 없음 -->
                <tr th:if="${loginLogs == null}">
                    <td colspan="10" style="text-align: center; padding: 30px 0;">검색 결과가 없습니다.</td>
                </tr>
                <!-- 조회 결과 contents -->
                <tr th:unless="${loginLogs == null}" th:each="l : ${loginLogs}">
                    <td class="table-data-center">
                        <input type="checkbox" name="selectList">
                    </td>
                    <td class="table-data-center"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

</th:block>

<!-- 사용자별 스크립트 작성 -->
<th:block layout:fragment="customJsCode">
    <script>
        let $searchId = document.getElementById('search-id');
        let $searchIdBtn = document.querySelector('.orderSearchBtn.submitBtn');
        const numFormat = num => num < 10 ? `0${num}` : num;
        const dateFormat = targetDate => {
            let year = targetDate.getFullYear();
            let month = numFormat(targetDate.getMonth()+1);
            let date = numFormat(targetDate.getDate());
            let hours = numFormat(targetDate.getHours());
            let minutes = numFormat(targetDate.getMinutes());
            let seconds = numFormat(targetDate.getSeconds());
            return `${year}-${month}-${date} ${hours}:${minutes}:${seconds}`;
        }
        $searchIdBtn.addEventListener('click',function (){
            let selectedStartDate = dateFormat(new Date(document.getElementById('start-date').value));
            let selectedEndDate = dateFormat(new Date(document.getElementById('end-date').value));
            console.log('포맷 입히기 전: ',new Date(document.getElementById('end-date').value));
            console.log(selectedStartDate);
            console.log(selectedEndDate);
            /* 유효성 검사  */
                if( $searchId.value.trim() === '' || typeof $searchId === 'undefined' || $searchId.value == null ) {
                    alert('회원 아이디를 입력해 주세요');
                }else{
                    $.ajax({
                        url : '/admin/user/getLoginLog',
                        method : 'POST',
                        data : {'memberId' : $searchId.value, 'startDate': selectedStartDate, 'endDate' : selectedEndDate },
                        dataType : 'json'
                    })
                        .done(function(response){
                            //$('.login-log tbody').empty();
                            if(document.querySelector('.login-log tbody').childElementCount>1){
                                document.querySelector('.login-log tbody').replaceChildren();
                            }
                            console.log(response)
                            // 표시할 데이터가 들어있는 HTML 코드를 생성
                            let html = '';
                            // 0.선택된 날짜 객체화
                            let selectedStartDate = new Date(document.getElementById('start-date').value);
                            let selectedEndDate = new Date(document.getElementById('end-date').value);

                            if(response.length > 0){
                                // 1. 선택한 날짜에 해당하는 기간만 필터링
                               let filteredData = response.filter(function (data){ // 반환값 true만 배열에 포함
                                   let loginTimeData = new Date(data.loginTime);
                                   let logoutTimeData = new Date(data.logoutTime);
                                   loginTimeData.setHours(0, 0, 0, 0);
                                   logoutTimeData.setHours(0, 0, 0, 0);
                                   let loginResult = (selectedStartDate <= loginTimeData && loginTimeData <= selectedEndDate);
                                   let logoutResult = (selectedStartDate <= logoutTimeData && logoutTimeData <= selectedEndDate);
                                   return loginResult || logoutResult;
                               });

                                // 2. 필터링된 데이터만 렌더링
                                filteredData.forEach(function (data) {
                                    html += '<tr>';
                                    html += '<td class="table-data-center"><input type="checkbox" name="selectList"></td>';
                                    html += '<td class="table-data-center">' + (data.loginLogCode )+ '</td>';
                                    html += '<td class="table-data-center">' + (data.memberId )+ '</td>';
                                    html += '<td class="table-data-center">' + (data.loginTime !== null && data.loginTime !== undefined ? data.loginTime : '-')+ '</td>';
                                    html += '<td class="table-data-center">' + (data.logoutTime !== null && data.logoutTime !== undefined ? data.logoutTime : '-')+ '</td>';
                                    html += '<td class="table-data-center">' + (data.clientNetAddress ) + '</td>';
                                    html += '</tr>';
                                });
                            }else{ // 해당하는 데이터 없는 경우
                                html += '<tr>';
                                html += '<td colSpan="6" style="text-align: center; padding: 30px 0;">검색 결과가 없습니다.</td>';
                                html += '</tr>';
                            }

                            // 표시할 위치에 HTML 코드를 삽입
                            $('.login-log tbody').html(html);
                        })

                        .fail(function (jqXHR, textStatus){
                            alert('통신 중 오류가 발생하였습니다');
                            console.log(`Request failed: ${textStatus}`);
                        })
                }
        })

    </script>
</th:block>
</html>