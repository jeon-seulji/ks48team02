<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ksmart.ks48team02.common.mapper.order.OrderMapper">

    <resultMap type="OrderTotal" id="orderMap">
        <id property="orderCode" column="order_code"/>
        <result property="memberId" column="member_id"/>
        <result property="orderCategoryCode" column="order_category_code"/>
        <result property="orderName" column="order_name"/>
        <result property="orderFundingName" column="order_funding_name"/>
        <result property="orderTotalPrice" column="order_total_price"/>
        <result property="orderCategoryDetail" column="order_category_detail"/>
        <result property="goodsCode" column="goods_code"/>
        <result property="goodsPartition" column="goodsPartition"/>
        <result property="orderApplicationDate" column="order_application_date"/>
        <result property="orderConfirmDate" column="order_confirm_date"/>
        <result property="orderCancellDate" column="order_cancell_date"/>
    </resultMap>

    <!-- order list 조회 -->
    <select id="getOrderList" parameterType="map" resultMap="orderMap">
        SELECT
            ot.order_code,
            ot.member_id,
            ot.order_category_code,
            ot.order_name,
            ot.order_funding_name,
            ot.order_total_price,
            ot.order_category_detail,
            ot.goods_code,
            substring(goods_code, 1,3) as goodsPartition,
            ot.order_application_date,
            ot.order_confirm_date,
            ot.order_cancell_date
        FROM
            order_table AS ot
        <choose>
            <when test="orderby == 'order_d'">
                ORDER BY ot.order_application_date DESC
            </when>
            <when test="orderby == 'order_a'">
                ORDER BY ot.order_application_date ASC
            </when>
            <when test="orderby == 'order_name_d'">
                ORDER BY ot.order_name DESC
            </when>
            <when test="orderby == 'order_name_a'">
                ORDER BY ot.order_name ASC
            </when>
            <when test="orderby == 'projecting_o'">
                WHERE ot.order_category_code IN ('ORDC_001','ORDC_002','ORDC_003')
                ORDER BY ot.order_application_date DESC
            </when>
            <when test="orderby == 'projectFail_o'">
                WHERE ot.order_category_code = 'ORDC_013'
                ORDER BY ot.order_application_date DESC
            </when>
            <when test="orderby == 'deliveryWait_o'">
                WHERE ot.order_category_code = 'ORDC_004'
                ORDER BY ot.order_application_date ASC
            </when>
            <when test="orderby == 'deliveryCompleted_o'">
                WHERE ot.order_category_code = 'ORDC_005'
                ORDER BY ot.order_application_date ASC
            </when>
            <when test="orderby == 'swapping_o'">
                WHERE ot.order_category_code IN ('ORDC_011','ORDC_012')
                ORDER BY ot.order_application_date ASC
            </when>
            <when test="orderby == 'refunding_o'">
                WHERE ot.order_category_code IN ('ORDC_009','ORDC_010')
                ORDER BY ot.order_application_date ASC
            </when>
            <when test="orderby == 'orderCompleted'">
                WHERE ot.order_category_code IN ('ORDC_006','ORDC_007','ORDC_008')
                ORDER BY ot.order_application_date ASC
            </when>
            <otherwise>
                ORDER BY ot.order_application_date DESC
            </otherwise>
        </choose>

        <if test="startRowNum > -1">
            LIMIT  #{startRowNum}, #{rowPerPage};
        </if>

    </select>


    <!-- 체크 포인트 : category code dto 적용한 로직으로 수정 -->
    <!-- 전체 주문 행 갯수 -->
    <select id="getOrderCnt" resultType="int" parameterType="String">
        /* 전체 주문 행 조회 */
        SELECT
            COUNT(1)
        FROM
            order_table
        <where>
            <if test="orderby == 'projecting_o'">
                order_category_code IN ('ORDC_001','ORDC_002','ORDC_003')

            </if>
            <if test="orderby == 'projectFail_o'">
                order_category_code = 'ORDC_013'

            </if>
            <if test="orderby == 'deliveryWait_o'">
                order_category_code = 'ORDC_004'

            </if>
            <if test="orderby == 'deliveryCompleted_o'">
                order_category_code = 'ORDC_005'

            </if>
            <if test="orderby == 'swapping_o'">
                order_category_code IN ('ORDC_011','ORDC_012')

            </if>
            <if test="orderby == 'refunding_o'">
                order_category_code IN ('ORDC_009','ORDC_010')

            </if>
            <if test="orderby == 'orderCompleted'">
                order_category_code IN ('ORDC_006','ORDC_007','ORDC_008')

            </if>

        </where>

    </select>

    <!-- 특정 주문 조회 -->
    <select id="getOrderInfoById" parameterType="String" resultMap="orderMap">
        /* 특정 주문 상세 조회 */
        SELECT
            ot.order_code,
            ot.member_id,
            ot.order_category_code,
            ot.order_name,
            ot.order_funding_name,
            ot.order_total_price,
            ot.order_category_detail,
            ot.goods_code,
            ot.order_application_date,
            ot.order_confirm_date,
            ot.order_cancell_date
        FROM
            order_table AS ot
        WHERE
            ot.order_code = #{orderCode};
    </select>

    <!-- 검색조건에 따른 주문 목록 조회 -->
    <select id="adminOrderSearchAjax" parameterType="SearchSelectDto" resultMap="orderMap">
        /* 검색조건에 따른 주문 목록 조회 */
        SELECT
            ot.order_code,
            ot.member_id,
            ot.order_category_code,
            ot.order_name,
            ot.order_funding_name,
            ot.order_total_price,
            ot.order_category_detail,
            ot.goods_code,
            ot.order_application_date,
            ot.order_confirm_date,
            ot.order_cancell_date
        FROM
        order_table AS ot
        <where>
            <if test="dateSettStartDate != null and dateSettStartDate != ''">
                DATE_FORMAT(ot.order_application_date, '%Y-%m-%d') >= #{searchForm.amDateSettStartDate}
                AND
            </if>
            <if test="dateSettEndDate != null and dateSettEndDate != ''">
                #{searchForm.amDateSettEndDate} >= DATE_FORMAT(ot.order_application_date, '%Y-%m-%d')
                AND
            </if>
            <if test="searchKey != null and searchKey != ''">
                ${searchForm.searchKey} LIKE CONCAT('%', #{searchForm.searchValue}, '%');
            </if>
        </where>
    </select>
</mapper>