<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ksmart.ks48team02.common.mapper.delivery.DeliveryMapper">

    <!-- delivery result Map -->
    <resultMap type="OrderDelivery" id="orderDeliveryMap">
        <id property="orderDeliveryCode" column="order_delivery_code"/>
        <result property="orderCode" column="order_code"/>
        <result property="deliveryCategoryCode" column="delivery_category_code"/>
        <result property="switchingCode" column="switching_code"/>
        <result property="rewardRefundCode" column="reward_refund_code"/>
        <result property="deliveryCategory" column="delivery_category"/>
        <result property="memberId" column="member_id"/>
        <result property="deliveryName" column="delivery_name"/>
        <result property="deliveryPhone" column="delivery_phone"/>
        <result property="deliveryAddress" column="delivery_address"/>
        <result property="deliveryMessage" column="delivery_message"/>
        <result property="deliveryMessageCode" column="delivery_message_code"/>
        <result property="numberInvoice" column="numberInvoice"/>
        <result property="deliveryCourier" column="delivery_courier"/>
        <result property="deliveryState" column="delivery_state"/>
        <result property="deliveryStartDate" column="delivery_start_date"/>
        <result property="deliveryEndDate" column="delivery_end_date"/>
        <result property="dueDateArrival" column="due_date_arrival"/>
    </resultMap>

    <!-- DeliveryCourierCategory map -->
    <resultMap id="deliveryCourierCategoryMap" type="DeliveryCourierCategory">
        <id property="deliveryCategoryCode" column="delivery_category_code"/>
        <result property="memberId" column="member_id"/>
        <result property="deliveryCourierName" column="delivery_courier_name"/>
        <result property="addDate" column="add_date"/>
        <result property="categoryStatus" column="category_status"/>
    </resultMap>

    <!-- 여기부터 작업 -->
    <sql id="deliveryListWhere">
        <where>
        <!-- 기간 선택 -->
        <if test="dateSettStartDate != null and dateSettStartDate != ''">
            DATE_FORMAT(ot.order_application_date, '%Y-%m-%d') >= #{dateSettStartDate}
        </if>
        <if test="dateSettEndDate != null and dateSettEndDate != ''">
            AND
            #{dateSettEndDate} >= DATE_FORMAT(ot.order_application_date, '%Y-%m-%d')
        </if>
        <!-- 공고 분류 선택 -->
        <if test="projectPartition != null">
            AND
            substring(goods_code, 1,3) IN
            <foreach collection="projectPartition" item="item" open="(" close=")"  separator=",">
                #{item}
            </foreach>
        </if>
        <!-- 공고 상태 선택 -->
        <if test="orderby == 'projecting_o'">
            AND
            ot.order_category_code IN ('ORDC_001','ORDC_002','ORDC_003')
        </if>
        <if test="orderby == 'projectFail_o'">
            AND
            ot.order_category_code = 'ORDC_013'
        </if>
        <if test="orderby == 'deliveryWait_o'">
            AND
            ot.order_category_code = 'ORDC_004'
        </if>
        <if test="orderby == 'deliveryCompleted_o'">
            AND
            ot.order_category_code = 'ORDC_005'
        </if>
        <if test="orderby == 'swapping_o'">
            AND
            ot.order_category_code IN ('ORDC_011','ORDC_012')
        </if>
        <if test="orderby == 'refunding_o'">
            AND
            ot.order_category_code IN ('ORDC_009','ORDC_010')
        </if>
        <if test="orderby == 'orderCompleted'">
            AND
            ot.order_category_code IN ('ORDC_006','ORDC_007','ORDC_008')
        </if>
        <!-- 키워드 선택 -->
        <if test="searchKey != null and searchKey == 'total'">
            AND
            (
            ot.order_code LIKE CONCAT('%', #{searchValue}, '%')
            OR
            ot.member_id LIKE CONCAT('%', #{searchValue}, '%')
            OR
            ot.order_name LIKE CONCAT('%', #{searchValue}, '%')
            OR
            ot.order_funding_name LIKE CONCAT('%', #{searchValue}, '%')
            )
        </if>
        <if test="searchKey != null and searchKey != 'total' and searchKey != ''">
            AND
            ot.${searchKey} LIKE CONCAT('%', #{searchValue}, '%');
        </if>
    </sql>
    <!-- delivery list  조회 -->
    <select id="getDeliveryList" parameterType="map" resultMap="orderDeliveryMap">
        SELECT
            od.order_delivery_code,
            od.order_code,
            od.delivery_category_code,
            od.switching_code,
            od.reward_refund_code,
            od.delivery_category,
            od.member_id,
            od.delivery_name,
            od.delivery_phone,
            od.delivery_address,
            od.delivery_message,
            od.numberInvoice,
            od.delivery_courier,
            od.delivery_state,
            od.delivery_start_date,
            od.delivery_end_date,
            od.delivery_end_date
        FROM
            order_delivery AS od
        <if test="startRowNum > -1">
            LIMIT ${startRowNum}, ${rowPerPage};
        </if>
    </select>


    <!-- 전체 행 수 조회 -->
    <select id="getDeliveryCnt" parameterType="map" resultType="int">
        SELECT
            COUNT(1)
        FROM
            order_delivery AS od

    </select>

    <!-- 특정 배송 정보 조회 -->
    <select id="getDeliveryByCode" parameterType="String" resultMap="orderDeliveryMap">
        SELECT
            od.order_delivery_code,
            od.order_code,
            od.delivery_category_code,
            od.switching_code,
            od.reward_refund_code,
            od.delivery_category,
            od.member_id,
            od.delivery_name,
            od.delivery_phone,
            od.delivery_address,
            od.delivery_message,
            od.numberInvoice,
            od.delivery_courier,
            od.delivery_state,
            od.delivery_start_date,
            od.delivery_end_date
        FROM
            order_delivery AS od
        WHERE
            od.order_delivery_code = #{orderDeliveryCode};
    </select>

    <select id="getDeliveryCourierCategory" resultMap="deliveryCourierCategoryMap">
        SELECT
            dcc.delivery_category_code,
            dcc.member_id,
            dcc.delivery_courier_name,
            dcc.add_date,
            dcc.category_status
        FROM
            delivery_courier_category AS dcc;
    </select>
</mapper>