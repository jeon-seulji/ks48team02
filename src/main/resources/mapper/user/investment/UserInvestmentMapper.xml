<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ksmart.ks48team02.user.mapper.investment.UserInvestmentMapper">

    <!--투자 프로젝트-->
    <resultMap id="InvestmentInfoResultMap" type="InvestmentInfo">
        <id property="investmentCode" column="investment_code"/>
        <result property="memberId" column="member_id"/>
        <result property="storeCode" column="store_code"/>
        <result property="investmentRequestJudgeCode" column="investment_request_judge_code"/>
        <result property="totalCategoryCode" column="total_category_code"/>
        <result property="memberIdSeller" column="member_id_seller"/>
        <result property="investmentSubject" column="investment_subject"/>
        <result property="investmentImage" column="investment_image"/>
        <result property="investmentLike" column="investment_like"/>
        <result property="investmentAmount" column="investment_amount"/>
        <result property="investmentAchievementMoney" column="investment_achievement_money"/>
        <result property="investAchievementPercent" column="invest_achievement_percent"/>
        <result property="investmentCompany" column="investment_company"/>
        <result property="searchCount" column="search_count"/>
        <result property="investCount" column="invest_count"/>
        <result property="securitiesClassification" column="securities_classification"/>
        <result property="investmentDisplayDate" column="investment_display_date"/>
        <result property="investmentRegDate" column="investment_reg_date"/>
        <result property="investmentDeadline" column="investment_deadline"/>
        <result property="investmentReport" column="investment_report"/>
        <result property="basicFee" column="basic_fee"/>
        <result property="contractFeeRate" column="contract_fee_rate"/>
        <result property="contractFile" column="contract_file"/>
        <result property="investJudgeSituation" column="invest_judge_situation"/>
        <result property="investmentDeadlineCnt" column="investmentDeadlineCnt"/>

        <association property="investmentContent" javaType="InvestmentContent">
            <id property="investmentContentCode" column="investment_content_code"/>
            <result property="memberId" column="member_id"/>
            <result property="investmentCode" column="investment_code"/>
            <result property="memberIdAdmin" column="member_id_admin"/>
            <result property="projectIntroduction" column="project_introduction"/>
            <result property="investmentIntroductionImage" column="investment_introduction_image"/>
            <result property="marketAnalysis" column="market_analysis"/>
            <result property="marketAnalysisImage" column="market_analysis_image"/>
            <result property="majorFinancialInformation" column="major_financial_information"/>
            <result property="majorFinancialInformationImage" column="major_financial_information_image"/>
            <result property="risk" column="risk"/>
            <result property="riskImage" column="risk_image"/>
            <result property="majorManpower" column="major_manpower"/>
            <result property="majorManpowerImage" column="major_manpower_image"/>
            <result property="patentAwardDetails" column="patent_award_details"/>
            <result property="patentAwardDetailsImage" column="patent_award_details_image"/>
            <result property="etcInvestContent" column="etc_invest_content"/>
            <result property="etcInvestContentImage" column="etc_invest_content_image"/>
            <result property="registrationDate" column="registration_date"/>
        </association>
    </resultMap>

    <insert id="addInvestment" parameterType="InvestmentInfo">
        /* 투자 프로젝트 등록 */
        <selectKey keyProperty="investmentCode" resultType="String" order="BEFORE">
            SELECT
                (CASE
                WHEN COUNT(i.investment_code) = 0 THEN CONCAT('inv_', CURDATE()+0, '_0001')
                WHEN COUNT(i.investment_code) > 9999 THEN CONCAT('inv_', CURDATE()+0, '_', MAX(CAST(SUBSTRING_INDEX(i.investment_code,'_',-1) AS UNSIGNED))+1)
                ELSE CONCAT('inv_', CURDATE()+0, '_', LPAD(MAX(CAST(SUBSTRING_INDEX(i.investment_code,'_',-1) AS UNSIGNED))+1, 4, '0'))
                END) AS investmentCode
            FROM
                investment AS i
            WHERE
                SUBSTRING_INDEX(SUBSTRING_INDEX(i.investment_code, '_', 2), '_', -1) = CURDATE()+0;
        </selectKey>
        INSERT INTO investment
            (investment_code, member_id, store_code, investment_request_judge_code, total_category_code, member_id_seller, investment_subject,
            investment_image, investment_like, investment_amount, investment_achievement_money, invest_achievement_percent,
            investment_company, search_count, invest_count, securities_classification, investment_display_date, investment_reg_date,
            investment_deadline, investment_report, basic_fee, contract_fee_rate, contract_file, invest_judge_situation)
        values
            (#{investmentCode},'id001', 'sto004', #{investmentRequestJudgeCode}, #{totalCategoryCode}, 'id002', #{investmentSubject},
            #{investmentImage}, '0', '0', '0', '0', #{investmentCompany}, '0', '0', #{securitiesClassification}, CURDATE(), #{investmentRegDate}, #{investmentDeadline},
            #{investmentReport}, '3000000', 'null', #{contractFile}, '0');
    </insert>

    <insert id="addInvestmentContent" parameterType="investmentInfo">
        /* 투자 프로젝트 상세내용 등록 */
        <selectKey keyProperty="investmentContentCode" resultType="String" order="BEFORE">
            SELECT
            (CASE
            WHEN COUNT(i.investment_content_code) = 0 THEN CONCAT('inv_con_', CURDATE()+0, '_0001')
            WHEN COUNT(i.investment_content_code) > 9999 THEN CONCAT('inv_con_', CURDATE()+0, '_', MAX(CAST(SUBSTRING_INDEX(i.investment_content_code,'_',-1) AS UNSIGNED))+1)
            ELSE CONCAT('inv_con_', CURDATE()+0, '_', LPAD(MAX(CAST(SUBSTRING_INDEX(i.investment_content_code,'_',-1) AS UNSIGNED))+1, 4, '0'))
            END) AS investmentContentCode
            FROM
            investment_content AS i
            WHERE
            SUBSTRING_INDEX(SUBSTRING_INDEX(i.investment_content_code, '_', 3), '_', -1) = CURDATE()+0;
        </selectKey>
        INSERT INTO InvestmentContent
        (investment_content_code, member_id, investment_code, member_id_admin, project_introduction,
        investment_introduction_image, market_analysis, market_analysis_image, major_financial_information,
        major_financial_information_image, risk, risk_image, major_manpower, major_manpower_image,
        patent_award_details, patent_award_details_image, etc_invest_content, etc_invest_content_image,
        registration_date)
        VALUES
        (#{investmentContentCode}, 'id002', #{investmentCode}, 'id001', #{projectIntroduction},
        #{investmentIntroductionImage}, #{marketAnalysis}, #{marketAnalysisImage}, #{majorFinancialInformation},
        #{majorFinancialInformationImage}, #{risk}, #{riskImage}, #{majorManpower}, #{majorManpowerImage},
        #{patentAwardDetails}, #{patentAwardDetailsImage}, #{etcInvestContent}, #{etcInvestContentImage},
        #{registrationDate})
    </insert>

    <select id="getInvestmentInfo" parameterType="String" resultMap="InvestmentInfoResultMap">
        SELECT
            investment_code,
            invest_achievement_percent,
            investment_subject,
            investment_amount,
            DATEDIFF(investment_deadline, CURDATE()) AS investmentDeadlineCnt,
            investment_image,
            investment_company
        FROM
            investment
    </select>



    <select id="getSortedList" parameterType="String" resultMap="InvestmentInfoResultMap">
        SELECT
            investment_code,
            invest_achievement_percent,
            investment_subject,
            investment_amount,
            DATEDIFF(investment_deadline, CURDATE()) AS investmentDeadlineCnt,
            investment_image,
            investment_company
        FROM
            investment
        <choose>
            <when test='orderBy == "recommendation"'>
                ORDER BY invest_achievement_percent DESC
            </when>
            <when test='orderBy == "latest"'>
                ORDER BY investment_reg_date DESC
            </when>
            <when test='orderBy == "popularity"'>
                ORDER BY investment_like DESC
            </when>
            <when test='orderBy == "recruitmentAmount"'>
                ORDER BY investment_amount DESC
            </when>
            <when test='orderBy == "deadline"'>
                ORDER BY investmentDeadlineCnt ASC
            </when>
            <otherwise>
                ORDER BY invest_achievement_percent DESC
            </otherwise>
        </choose>
    </select>

    <select id="getInvestmentContent" parameterType="String" resultType="InvestmentContent">
        SELECT * FROM investment_content
        WHERE investment_code = #{investmentCode}
    </select>



</mapper>