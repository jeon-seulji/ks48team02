<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ksmart.ks48team02.user.mapper.main.UserMainMapper">



    <!-- rank list -->
    <resultMap type="OrderRank" id="orderRankMap">
        <result property="rankCount" column="rankCount"/>
        <result property="projectCode" column="projectCode"/>
        <result property="subject" column="subject"/>
        <result property="imageUrl" column="imageUrl"/>
        <result property="projectType" column="projectType"/>
        <result property="categoryName" column="categoryName"/>
        <result property="storeName" column="storeName"/>
        <result property="achievementPercent" column="achievementPercent"/>
        <result property="likeCount" column="likeCount"/>
    </resultMap>

    <!-- reward project list map -->
    <resultMap id="rewardProjectMap" type="RewardProject">
        <id property="rewardProjectCode" column="reward_project_code"/>
        <result property="rewardCategoryCode" column="total_cagegory_code"/>
        <result property="regMemberId" column="member_id"/>
        <result property="adminMemberId" column="admin_member_id"/>
        <result property="storeCode" column="store_code"/>
        <result property="projectSubject" column="project_subject"/>
        <result property="projectContents" column="project_contents"/>
        <result property="rewardLike" column="reward_like"/>
        <result property="projectThumbnailImage" column="project_thumbnail_image"/>
        <result property="projectAchievementMoney" column="project_achievement_money"/>
        <result property="projectGoalMoney" column="project_goal_money"/>
        <result property="projectAchievementPercent" column="project_achievement_percent"/>
        <result property="regCompany" column="reg_company"/>
        <result property="projectRegDate" column="project_reg_date"/>
        <result property="searchCount" column="search_count"/>
        <result property="projectJudgmentReason" column="project_judgment_reason_detail"/>
        <result property="projectJudgementDate" column="project_judgment_date"/>
        <result property="projectStartDate" column="project_start_date"/>
        <result property="projectEndDate" column="project_end_date"/>
        <result property="projectCondition" column="project_condition"/>
        <result property="categoryName" column="category_name"/>
    </resultMap>

    <!-- donation project list map -->
    <resultMap id="donationProjectMap" type="DonationRegistration">
        <id property="donationCode" column="donation_code"/>
        <result property="donationSubject" column="donation_subject"/>
        <result property="donationAchievementPercent" column="donation_achievement_percent"/>
        <result property="categoryName" column="category_name"/>
        <result property="storeName" column="store_name"/>
    </resultMap>

    <!-- investment project list map -->
    <resultMap id="investProjectMap" type="InvestmentInfo">
        <id property="investmentCode" column="investment_code"/>
        <result property="investmentSubject" column="investment_subject"/>
        <result property="investmentImage" column="investment_image"/>
        <result property="investAchievementPercent" column="invest_achievement_percent"/>
        <result property="categoryName" column="category_name"/>
        <result property="investmentCompany" column="investment_company"/>
    </resultMap>

    <!-- 공고 resultset -->
    <sql id="resultset">
        WITH resultset AS (
            SELECT
                r.reward_project_code AS projectCode,
                r.total_cagegory_code AS categoryCode,
                r.project_subject AS subject,
                r.store_code AS storeCode,
                '리워드' AS projectType,
                r.project_achievement_percent AS achievementPercent,
                r.reward_like AS likeCount
            FROM
                reward_project AS r
            WHERE
                r.project_condition not IN(4,5)
            UNION ALL
            SELECT
                d.donation_code AS projectCode,
                d.total_category_code AS categoryCode,
                d.donation_subject AS subject,
                d.store_code AS storeCode,
                '기부' AS projectType,
                d.donation_achievement_percent AS achievementPercent,
                d.donation_like AS likeCount
            FROM
                donation AS d
            WHERE
                d.donation_condition not IN(4,5)
            UNION ALL
            SELECT
                i.investment_code AS projectCode,
                i.total_category_code AS categoryCode,
                i.investment_subject AS subject,
                i.store_code AS storeCode,
                '투자' AS projectType,
                i.invest_achievement_percent AS achievementPercent,
                i.investment_like AS likeCount
            FROM
                investment AS i
            WHERE
                i.invest_judge_situation != 5
            ORDER BY ${rankCategory} DESC
            LIMIT 5
        ) -- cte
    </sql>

    <!-- rank list contents -->
    <select id="getRankList" parameterType="String" resultMap="orderRankMap">
       <include refid="resultset"/>
        SELECT
            RANK() OVER(ORDER BY ${rankCategory} DESC) AS rankCount,
            rs.projectCode AS projectCode,
            rs.subject AS subject,
            rs.projectType AS projectType,
            ifnull(tc.category_name, '') AS categoryName,
            s.store_name AS storeName,
            rs.achievementPercent AS achievementPercent,
            rs.likeCount AS likeCount
        FROM
            resultset AS rs
            LEFT OUTER JOIN
            total_category AS tc
            ON rs.categoryCode = tc.total_category_code
            INNER JOIN
            store AS s
            ON rs.storeCode = s.store_code;
    </select>

    <!-- get reward project list for main -->
    <select id="getRewardPrjList" resultMap="rewardProjectMap">
        SELECT
            rp.reward_project_code,
            rp.project_subject,
            rp.project_achievement_percent,
            tc.category_name,
            rp.reg_company,
            rp.total_cagegory_code
        FROM
            reward_project AS rp
            INNER JOIN
            total_category AS tc
            ON rp.total_cagegory_code = tc.total_category_code
        WHERE
            rp.project_condition = 3
        ORDER BY rp.project_achievement_percent DESC
            LIMIT 15;
    </select>

    <!-- get donation project list for main -->
    <select id="getDonationPrjList" resultMap="donationProjectMap">
        SELECT
            dp.donation_code,
            dp.donation_subject,
            dp.donation_achievement_percent,
            s.store_name,
            tc.category_name
        FROM
            donation AS dp
            INNER JOIN
            store AS s
            ON dp.store_code = s.store_code
            INNER JOIN
            total_category AS tc
            ON dp.total_category_code = tc.total_category_code
        WHERE
            dp.donation_condition = 3
        ORDER BY dp.donation_achievement_percent DESC
        LIMIT 15;
    </select>

    <!-- get investment list for main -->
    <select id="getInvestPrjList" resultMap="investProjectMap">
        SELECT
            ip.investment_code,
            ip.investment_subject,
            ip.investment_image,
            ip.invest_achievement_percent,
            tc.category_name,
            ip.investment_company
        FROM
            investment AS ip
            INNER JOIN
            total_category AS tc
            ON ip.total_category_code = tc.total_category_code
        WHERE
            ip.invest_judge_situation = 3
        ORDER BY ip.invest_achievement_percent DESC
        LIMIT 15;
    </select>
</mapper>