<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ksmart.ks48team02.user.mapper.donation.DonationRegistrationMapper">

    <resultMap id="DonationRegistrationResultMap" type="DonationRegistration">
        <id property="donationCode" column="donation_code"></id>
        <result property="storeCode" column="store_code"></result>
        <result property="memberId" column="member_id"></result>
        <result property="donationCategoryCode" column="donation_category_code"></result>
        <result property="donationJudgementReasonCode" column="donation_judgement_reason_code"></result>
        <result property="adminMemberId" column="admin_member_id"></result>
        <result property="donationSubject" column="donation_subject"></result>
        <result property="donationContents" column="donation_contents"></result>
        <result property="donationImage" column="donation_image"></result>
        <result property="donationRegCompany" column="donation_reg_company"></result>
        <result property="donationRegDate" column="donation_reg_date"></result>
        <result property="donationStartDate" column="donation_start_date"></result>
        <result property="donationEndDate" column="donation_end_date"></result>
        <result property="donationAchievementMoney" column="donation_achievement_money"></result>
        <result property="donationGoalMoney" column="donation_goal_money"></result>
        <result property="donationAchievementPercent" column="donation_achievement_percent"></result>
        <result property="donationJudgmentReasonDetail" column="donation_judgment_reason_detail"></result>
        <result property="donationJudgementDate" column="donation_judgement_date"></result>
        <result property="searchCount" column="search_count"></result>
        <result property="donationCondition" column="donation_condition"></result>
    </resultMap>

    <insert id="addDonation" parameterType="ksmart.ks48team02.user.dto.donation.DonationRegistration">
        /* 기부 상품 등록*/
        <selectKey keyProperty="donationCode" resultType="String" order="BEFORE">
            SELECT
            (CASE
            WHEN COUNT(d.donation_reg_date) = 0 THEN CONCAT('don_', CURDATE()+0, '_0001')
            WHEN COUNT(d.donation_reg_date) > 9999 THEN CONCAT('don_', CURDATE()+0, '_', COUNT(d.donation_reg_date)+1)
            ELSE CONCAT('don_', CURDATE()+0, '_', LPAD(COUNT(d.donation_reg_date)+1, 4, '0'))
            END) AS donationCode
            FROM
            donation AS d
            WHERE
            DATE_FORMAT(d.donation_reg_date, '%Y-%m-%d') = CURDATE();
        </selectKey>
        INSERT INTO donation
        (donation_code, store_code, member_id, donation_category_code, donation_judgement_reason_code, admin_member_id, donation_subject,
        donation_contents, donation_image, donation_reg_company, donation_reg_date, donation_start_date, donation_end_date, donation_achievement_money,
        donation_goal_money, donation_achievement_percent, donation_judgment_reason_detail, donation_judgement_date, search_count, donation_condition)

        VALUES(#{donationCode}, 'sto_001', 'id003', 'don_ct_001', NULL, NULL, #{donationSubject}, #{donationContents}
        , '대표 Image url', '녹십자회', NOW(), NULL, #{donationEndDate}, 0, #{donationGoalMoney}, 0, NULL, NULL, 0, 0);
    </insert>

</mapper>